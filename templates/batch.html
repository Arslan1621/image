<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Processing - Image Redaction Tool</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 15px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            cursor: pointer;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .upload-area:hover {
            border-color: #0056b3;
            background: linear-gradient(145deg, #e9ecef, #dee2e6);
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: linear-gradient(145deg, #d4edda, #c3e6cb);
        }
        
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            background: #f8f9fa;
        }
        
        .file-item {
            background: white;
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .options-card {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
        }
        
        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .result-container {
            background: linear-gradient(145deg, #d4edda, #c3e6cb);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .nav-pills .nav-link {
            border-radius: 25px;
            margin: 0 5px;
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(45deg, #007bff, #0056b3);
        }
        
        .stats-card {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <div class="text-center mb-4">
                <h1 class="display-4 text-primary mb-3">
                    <i class="fas fa-images me-3"></i>
                    Batch Processing
                </h1>
                <p class="lead text-muted">Process multiple images simultaneously with advanced AI redaction</p>
                
                <!-- Navigation -->
                <ul class="nav nav-pills justify-content-center mb-4">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-image me-2"></i>Single Image
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-images me-2"></i>Batch Processing
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Upload Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                        <h4>Drop multiple images here or click to browse</h4>
                        <p class="text-muted">Select multiple files for batch processing (Max 16MB each)</p>
                        <input type="file" id="fileInput" class="d-none" accept="image/*" multiple>
                    </div>
                </div>
            </div>
            
            <!-- File List Section -->
            <div class="row mb-4" id="fileListSection" style="display: none;">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                Selected Files (<span id="fileCount">0</span>)
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="file-list" id="fileList">
                                <!-- Files will be listed here -->
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" id="clearFilesBtn">
                                <i class="fas fa-trash me-2"></i>Clear All
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card options-card h-100">
                        <div class="card-body">
                            <h5 class="card-title text-center mb-4">
                                <i class="fas fa-cogs me-2 text-primary"></i>
                                Batch Options
                            </h5>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="batchBlurFaces" checked>
                                <label class="form-check-label" for="batchBlurFaces">
                                    <i class="fas fa-user-secret me-2"></i>Blur Faces
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="batchRedactPlates" checked>
                                <label class="form-check-label" for="batchRedactPlates">
                                    <i class="fas fa-car me-2"></i>Redact License Plates
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="batchRedactText" checked>
                                <label class="form-check-label" for="batchRedactText">
                                    <i class="fas fa-font me-2"></i>Redact Text
                                </label>
                            </div>
                            
                            <div class="mb-3">
                                <label for="batchBlurIntensity" class="form-label">
                                    <i class="fas fa-adjust me-2"></i>Blur Intensity
                                </label>
                                <input type="range" class="form-range" id="batchBlurIntensity" min="5" max="50" value="15">
                                <div class="text-center text-muted"><span id="batchBlurValue">15</span></div>
                            </div>
                            
                            <button class="btn btn-primary w-100" id="processBatchBtn" disabled>
                                <i class="fas fa-play me-2"></i>Start Processing
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-number" id="processedCount">0</div>
                            <div>Processed</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-number" id="totalCount">0</div>
                            <div>Total</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-number" id="percentComplete">0%</div>
                            <div>Complete</div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span id="progressText">Processing images...</span>
                </div>
                
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progressBar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="result-container" id="resultContainer" style="display: none;">
                <div class="text-center">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h4 class="text-success">Batch Processing Complete!</h4>
                    <p id="resultSummary" class="mb-4"></p>
                    
                    <button class="btn btn-success btn-lg" id="downloadZipBtn">
                        <i class="fas fa-download me-2"></i>Download All Results (ZIP)
                    </button>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-primary" onclick="location.reload()">
                            <i class="fas fa-redo me-2"></i>Process More Images
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Features Section -->
            <div class="row mt-5">
                <div class="col-md-3 text-center mb-4">
                    <i class="fas fa-tachometer-alt fa-2x text-primary mb-3"></i>
                    <h6>Fast Processing</h6>
                    <p class="text-muted small">Multi-threaded processing for maximum speed</p>
                </div>
                <div class="col-md-3 text-center mb-4">
                    <i class="fas fa-shield-alt fa-2x text-primary mb-3"></i>
                    <h6>AI-Powered</h6>
                    <p class="text-muted small">Advanced machine learning for accurate detection</p>
                </div>
                <div class="col-md-3 text-center mb-4">
                    <i class="fas fa-file-archive fa-2x text-primary mb-3"></i>
                    <h6>ZIP Download</h6>
                    <p class="text-muted small">Convenient batch download of all processed images</p>
                </div>
                <div class="col-md-3 text-center mb-4">
                    <i class="fas fa-cogs fa-2x text-primary mb-3"></i>
                    <h6>Configurable</h6>
                    <p class="text-muted small">Flexible options for different redaction needs</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedFiles = [];
        let processId = null;
        
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileListSection = document.getElementById('fileListSection');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const clearFilesBtn = document.getElementById('clearFilesBtn');
        const processBatchBtn = document.getElementById('processBatchBtn');
        const progressContainer = document.getElementById('progressContainer');
        const resultContainer = document.getElementById('resultContainer');
        const batchBlurIntensity = document.getElementById('batchBlurIntensity');
        const batchBlurValue = document.getElementById('batchBlurValue');
        
        // Update blur intensity display
        batchBlurIntensity.addEventListener('input', function() {
            batchBlurValue.textContent = this.value;
        });
        
        // Upload area click handler
        uploadArea.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Drag and drop handlers
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            handleMultipleFiles(files);
        });
        
        // File input change handler
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            handleMultipleFiles(files);
        });
        
        // Handle multiple file selection
        function handleMultipleFiles(files) {
            const imageFiles = files.filter(file => {
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp', 'image/tiff', 'image/gif'];
                return allowedTypes.includes(file.type) && file.size <= 16 * 1024 * 1024;
            });
            
            if (imageFiles.length === 0) {
                alert('Please select valid image files (JPG, PNG, BMP, TIFF, GIF) under 16MB each');
                return;
            }
            
            if (files.length > imageFiles.length) {
                alert(`${files.length - imageFiles.length} files were rejected (invalid format or too large)`);
            }
            
            // Upload files
            uploadFiles(imageFiles);
        }
        
        // Upload files to server
        function uploadFiles(files) {
            const formData = new FormData();
            files.forEach(file => {
                formData.append('files', file);
            });
            
            // Show loading state
            uploadArea.innerHTML = `
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <h4>Uploading ${files.length} files...</h4>
                <p class="text-muted">Please wait while we upload your images</p>
            `;
            
            fetch('/batch_upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    selectedFiles = data.uploaded_files;
                    
                    // Show success state
                    uploadArea.innerHTML = `
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h4 class="text-success">Upload Successful!</h4>
                        <p class="text-muted">${data.count} images ready for processing</p>
                    `;
                    
                    // Update file list
                    updateFileList();
                    fileListSection.style.display = 'block';
                    processBatchBtn.disabled = false;
                } else {
                    throw new Error(data.error);
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                uploadArea.innerHTML = `
                    <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                    <h4 class="text-danger">Upload Failed</h4>
                    <p class="text-muted">${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="location.reload()">Try Again</button>
                `;
            });
        }
        
        // Update file list display
        function updateFileList() {
            fileList.innerHTML = '';
            fileCount.textContent = selectedFiles.length;
            
            selectedFiles.forEach((filename, index) => {
                const originalName = filename.replace(/^\d{8}_\d{6}_/, ''); // Remove timestamp prefix
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="d-flex align-items-center flex-grow-1">
                        <i class="fas fa-image text-primary me-2"></i>
                        <span class="text-truncate">${originalName}</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        }
        
        // Remove file from list
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            
            if (selectedFiles.length === 0) {
                fileListSection.style.display = 'none';
                processBatchBtn.disabled = true;
                uploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                    <h4>Drop multiple images here or click to browse</h4>
                    <p class="text-muted">Select multiple files for batch processing (Max 16MB each)</p>
                `;
            }
        }
        
        // Clear all files
        clearFilesBtn.addEventListener('click', function() {
            selectedFiles = [];
            fileListSection.style.display = 'none';
            processBatchBtn.disabled = true;
            uploadArea.innerHTML = `
                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                <h4>Drop multiple images here or click to browse</h4>
                <p class="text-muted">Select multiple files for batch processing (Max 16MB each)</p>
            `;
        });
        
        // Process batch
        processBatchBtn.addEventListener('click', function() {
            if (selectedFiles.length === 0) {
                alert('Please upload images first');
                return;
            }
            
            const options = {
                blur_faces: document.getElementById('batchBlurFaces').checked,
                redact_plates: document.getElementById('batchRedactPlates').checked,
                redact_text: document.getElementById('batchRedactText').checked,
                blur_intensity: parseInt(batchBlurIntensity.value)
            };
            
            // Show progress
            progressContainer.style.display = 'block';
            resultContainer.style.display = 'none';
            processBatchBtn.disabled = true;
            
            document.getElementById('totalCount').textContent = selectedFiles.length;
            
            fetch('/batch_process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filenames: selectedFiles,
                    options: options
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.process_id) {
                    processId = data.process_id;
                    checkBatchProcessingStatus();
                } else {
                    throw new Error(data.error || 'Processing failed');
                }
            })
            .catch(error => {
                console.error('Processing error:', error);
                progressContainer.style.display = 'none';
                processBatchBtn.disabled = false;
                alert('Processing failed: ' + error.message);
            });
        });
        
        // Check batch processing status
        function checkBatchProcessingStatus() {
            if (!processId) return;
            
            fetch(`/status/${processId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'processing') {
                    document.getElementById('processedCount').textContent = data.processed;
                    document.getElementById('percentComplete').textContent = data.progress + '%';
                    document.getElementById('progressBar').style.width = data.progress + '%';
                    document.getElementById('progressText').textContent = `Processing: ${data.processed}/${data.total} images`;
                    
                    // Continue checking
                    setTimeout(checkBatchProcessingStatus, 1000);
                } else if (data.status === 'completed') {
                    document.getElementById('processedCount').textContent = data.processed;
                    document.getElementById('percentComplete').textContent = '100%';
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressText').textContent = 'Processing complete!';
                    
                    // Show results
                    setTimeout(function() {
                        progressContainer.style.display = 'none';
                        resultContainer.style.display = 'block';
                        processBatchBtn.disabled = false;
                        
                        document.getElementById('resultSummary').textContent = 
                            `Successfully processed ${data.processed} out of ${data.total} images`;
                        
                        document.getElementById('downloadZipBtn').onclick = function() {
                            window.open(`/download/${data.zip_filename}`, '_blank');
                        };
                    }, 1000);
                } else if (data.status === 'error') {
                    progressContainer.style.display = 'none';
                    processBatchBtn.disabled = false;
                    alert('Processing failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Status check error:', error);
                progressContainer.style.display = 'none';
                processBatchBtn.disabled = false;
            });
        }
    </script>
</body>
</html>